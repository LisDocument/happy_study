# MySQL 中突然就提高性能的方案

首先明确一点，这些方案必然是有损的，如果是无损的方案，那么不至于在这种时候上场

## 短链接风暴

正常的短链接模式是连接到数据库后，执行很少的SQL语句就断开，下次需要的时候再重连，如果是短链接，就存在业务高峰期链接数暴涨的情况，而MySQL建立连接的过程，成本是很高的，除了正常的网络连接三次握手之外，还要做登录权限判断和获得这个连接的数据读写权限。

在数据库压力比较小的时候，这些额外的成本并不明显。

但是短链接模型存在风险，一旦数据库处理慢了，链接数就会暴涨。**max_connections**参数，就是用来控制一个MySQL实例存在的链接数的上限。超过这个系统就会拒绝接下来的请求，并且报错“too many connections”。

那么如果提高**max_connections**的值呢，这么做是有风险的。这个限制的存在是为了保护MySQL，如果改的太大能够让更多的连接进来，那么系统的负载可能会进一步加大，大量的资源耗费在权限验证的逻辑上。导致已经连接的线程拿不到CPU资源去执行业务的SQL请求。

那么 有别的方案么

### 处理占着茅坑不拉屎的线程

**max_connections**的计算，是按当前链接数计算的。对于那些不需要保持的连接，可以通过kill connection 主动踢掉。这种行为类似wait_timeout的直接断开连接。

show processlist结果中，踢掉显示为sleep的线程。这操作可能是有损的，比如说一个更新语句，事务还没有提交，然后被直接断开，此时MySQL只能按照回滚事务来处理。因此，希望断开的是事务外空闲的连接。如果要看具体状态的话，可以查看information_schema库的innodb_trx表。

### 减少连接过程的消耗

让数据库跳过权限验证的阶段

重启数据库使用-skip-grant-tables参数启动，这个操作风险极高，如果库外网可访问的话，就更不能这么做了

MySQL8.0如果启用这个参数的话，会默认把--skip-networking打开，表示此时只能被本地客户端连接

## 慢查询性能问题

### 索引没设计好

如果发生这种情况一般通过紧急创建索引来解决，MySQL5.6后，创建索引支持OnlineDDL了，对于高峰期数据库已经被这个语句打挂了的情况，最好的就是直接执行alter table语句了。

如果当前是主备数据库的话，那么可以这么操作

1. 备库关闭binlog，执行alter语句加上索引
2. 主备切换
3. 在原主库关闭binlog，执行语句加上索引

### 语句没写好

SQL语句经常会出现没有使用上索引的问题，可以直接改写SQL语句，MySQL5.7提供了query_rewrite功能，可以把输入的语句改写成另外一种模式。

```mysql
mysql> insert into query_rewrite.rewrite_rules(pattern, replacement, pattern_database) values ("select * from t where id + 1 = ?", "select * from t where id = ? - 1", "db1");

call query_rewrite.flush_rewrite_rules();
```

### QPS突增

1. 因为全新业务的bug导致的。假如DB运维规范，那么白名单是一个个加的。这种情况下，如果你能确定业务方会下掉这个功能，只是时间上没那么快，那么就可以从数据库端把白名单去掉
2. 如果新功能使用的是单独的数据库用户，可以用管理员账号把这个用户删掉，然后断开现有连接
3. 如果新增的功能和主题功能是部署在一起的，那么我们只能用处理语句来限制，这时可以使用上面的查询重写功能，把压力最大的SQL语句写为select 1 返回。
   1. 容易有SQL的误伤
   2. 很多业务不是靠一个语句完成逻辑，这个的修改可能会导致后面的业务逻辑一起失败