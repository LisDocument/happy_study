# 系统架构设计师

## 1 计算机组成与体系结构

### 1.1 计算机系统组成

#### 1.1.1 计算机硬件组成

硬件是设备实体，冯诺伊曼计算机结构上以**运算器**为中心，现在转向**存储器**为核心

- 控制器(主机->CPU)：统一控制指挥并控制计算机各部件协调工作的中心部件
  - 程序计算器PC：存储下一条执行指令的地址
  - 指令寄存器IR：存储即将执行的指令
  - 指令译码器ID：对指令中的操作码字段进行分析解释
  - 时序部件：时序控制信号
- 运算器(主机->CPU)：ALU，在控制器控制下完成算术运算和逻辑运算。
  - 算数逻辑单元ALU：数据的算数运算和逻辑运算。
  - 累加寄存器AC：为ALU提供工作区暂存数据
  - 数据缓冲寄存器DR：写内存时暂存指令或数据
  - 状态条件寄存器PSW：存状态标志与控制标识(争议：也可归于控制器)
- 主存储器(主机)：存储现场操作的信息和中间结果，包括机器指令和数据
- 辅助存储器(外设)：外存/辅存。存储需要长期保存的各种信息
- 输入设备
- 输出设备

#### 1.1.2 计算机系统结构的分类

电子管->晶体管->集成电路（中小规模，大规模，超大规模，甚大规模，极大规模）

世界上最高水平的单片集成电路芯片上容纳的元器件已经达到**80多亿**个。

1）存储程序的概念：冯诺伊曼1946.6提出。

- 计算机（硬件）应由运算器、存储器、控制器、输入和输出设备这五个基本部件组成
- 计算机内部使用二进制来表示指令和数据
- 将程序和原始数据存入存储器中，然后启动计算机工作。这就是存储程序的基本含义

**存储程序控制**概念的提出和实现时冯诺伊曼对计算机界的最大贡献。这种计算机叫做冯诺伊曼计算机。但存在存储器访问的瓶颈。对于突破这种瓶颈的计算机叫做非冯诺伊曼型计算机（数据驱动的数据流计算机，需求驱动的规约计算机，模式匹配驱动的智能计算机）

2）Flynn分类

根据指令流，数据流的多倍性特征分类。

- 指令流：机器执行的指令序列
- 数据流：指令流调用的数据序列。包括输入数据和中间结果。不包括输出数据。

2*2，将计算机系统分成4类

- 单指令流单数据流；SISD，传统顺序执行的单处理器计算机。其指令部件每次只对一条指令进行译码，只对一个操作部件分配数据
- 单指令流多数据流：SIMD，以并行处理机（矩阵处理机）为代表，并行处理机包括多个重复的处理单元，由单一指令部件控制，按照统一指令流的要求为他们分配各自不同所需的不同数据
- 多指令流单数据流：MISD，具有N个处理单位，按N条不同指令的要求对同一数据流及其中间结果进行不同的处理。一个处理单元的输出又作为另一个处理单元的输入。这类系统较少，可参照流水线理解，也有文献称流水线计算机是MIMD
- 多指令流多数据流：MIMD，能实现作业、任务、指令等各级全面并行的多机系统。如多核处理器，多处理机属于MIMD

#### 1.1.3 复杂指令集系统和精简指令集系统

指令优化设计又两个截然相反的方向

- 增强指令的功能，设置一些功能复杂的指令，把一些原来由软件实现的常用的功能改用指令系统来实现（仿佛是造轮子？）。这种计算机系统被称为复杂指令系统计算机（CISC）
  - 指令数量众多，通常有100-250条
  - 使用频率相差悬殊，最长使用简单的指令仅占指令总数的20%出现了80%，大部分复杂指令很少使用（典型的二八原则啊）
  - 支持很多寻址方式，支持的通常为5-20种
  - 变长的指令，指令长度不规定。增加指令译码电路的复杂性
  - 指令可以对主存单元的数据直接进行处理。执行速度较慢
  - 微程序控制为主。CISC指令系统复杂，很难用硬布线逻辑（组合逻辑）电路实现控制器，通常使用微程序控制。
- 尽量简化指令功能，只保留那些功能简单，能在一个节拍内执行完成指令，复杂的功能用一段子程序来实现。这种计算机系统成为精简指令系统计算机（RISC）
  - 指令少，优鲜选取使用频率高的一些简单指令和常用指令。只提供了LOAD（存储器读数）和STORE（数据写入存储器）两条指令对存储器操作，其他都在CPU的寄存器之间进行
  - 寻址方式少。通常只有寄存器寻址，立即数寻址和相对寻址
  - 指令长度固定。译码简单
  - 硬布线逻辑控制为主。为了提供操作的执行速度，通常采用硬布线逻辑来构建控制器
  - 单周期指令执行。采用流水线技术。少数指令可能需要多周期（LOAD/STORE因为要访问存储器，执行的时间会稍微长）
  - 优化的编译器：RISC使编译工作简单化。因为指令长度固定，格式少，寻址方式少，编译时不必在具有相似功能的指令中进行选择，也不必为寻址方式的选择而费心，易于实现优化。
  - CPU种通用寄存器数量多，一般在32以上，甚至可达上千个。大多RISC采用了Cache方案，使用Cache来提供取指令的速度。有的RISC使用两个独立的Cache来改善性能，一个为指令Cache一个时数据Cache，这样取指令和取数据可以同时进行互不干扰。

#### 1.1.4 总线

一组能为多个部件分时（同一时刻只允许一个部件向总线发送消息，允许多个部件同时接受同样信息）共享（总线可以挂接多个部件，各个部件之间相关交换的信息都可以通过这组公共线路传送）的公共信息传送线路。

按总线相对CPU或其他芯片的位置可分为：

- CPU内部，寄存器之间和算数逻辑部件ALU与控制部件之间传输数据的总线为内部总线；
- 外部总线则是CPU与内存RAM，ROM和输入输出设备接口之间通信的通路。**总线速度**是制约计算机整体性能的最大因素。

功能分：

- 地址总线：传送地址信息
- 数据总线：传送数据信息
- 控制总线：传送各种控制信号

### 1.2 存储器系统

#### 1.2.1 主存储器

存放计算机运行期间需要的程序和数据，CPU可随机进行读写。存取速度较高。

根据工艺和技术不同，可分为

- 随机存取存储器：RAM，可写可读，断电后信息无法保存，只能暂存。
  - DRAM：随时间逐渐消失，需要定时对其刷新维持消息不丢失，密度大于SRAM且更加便宜。
  - SRAM：在不断电的情况下信息能够一直保持不会丢失。电路简单，容量小，价格高
- 只读存储器：ROM，**一种RAM的特殊形式**，写入后只能随机读出不能写入。又被称为固定存储器，一般存放系统程序BIOS

内存编址在计算机系统中，存储器每个单元的位数是相同且固定的，称为存储器编址单位

内存一般以字节（8位）为单位，或者以字（会标注大小，16位或者32位）为单位

<u>内存地址H1到H2，则共有H2-H1+1个地址单元，写作H3。如果内存地址按字（16bit）编址，则共有H3*16位，假设内存有X片存储器芯片构成，每片有H4个存储单位，则每个单元存储（H3 * 16）/ （X * H4）位</u>

#### 1.2.2 辅助存储器

- 磁带存储器是一种顺序存取的设备。存取时间较长，存储容量大，便于携带，价格便宜。目前应用场景极少，用于资料的归档保存。
- 硬盘存储器。
  - 磁盘片有m个磁道就有m个柱面。会讲一个文件尽量的存放在同一个柱面种，如果存放不完，再存入相邻的柱面。
  - 通常将一条磁道划分为若干个段，每个段成为一个扇区或者扇段，每个扇区存放一个定长信息块（例如512个字节，由操作系统决定），**扇区从编号1开始，磁头和柱面编号从0开始**
  - 磁盘访问时间（存取时间）=寻道时间+旋转延迟时间

#### 1.2.3 Cache存储器

Cache的功能是提供CPU数据输入输出的速率，突破冯诺伊曼瓶颈（内存速度）。Cache容量小但是速度快，内存速度低但是容量大通过优化调度算法，系统的性能会大大改善。

Cache通常采用相联存储器（CAM）。CAM是一种基于**数据内容**进行访问的存储设备。在写入数据时，CAM能够自动选择一个未用的空单元进行存储；<u>当要读出数据时，不是给出其存储单元的地址，而是直接给出该数据或者该数据的一部分内容</u>，CAM对所有的存储单元中的数据同时进行比较，标记符合条件的所有数据以供读取。由于比较是同时、并行进行的，所以基于数据内容进行读写的机制，速度比基于地址读写方式要快得多。

##### 基本原理

使用Cache改善系统性能的依据是程序的局部性原理。根据程序的局部性原理，最近的、未来要用的指令和数据大多局限于正在用的指令和数据，或者存放在与这些指令和数据位置上临近的单元中。

如果h表示Cache的访问命中率，t1表示cache的周期时间，t2表示内存的周期时间，以读操作为例，使用Cache+主存储器的系统的平均周期为t3，则公式为：t3 = t1*h + t2(1-h)

##### 映射机制

当CPU发出访存请求后，存储器地址先被送到Cache控制器以确定数据是否已在Cache中，若命中则直接对Cache进行访问。这个过程称为Cache的地址映射。在Cache的地址映射中，主存和Cache将均分成容量相同的块（页）。常见有直接映射，全相联映射和组相联映射。

###### 直接映射

以随机存取存储器作为Cache存储器，硬件电路较简单。

设定内存容量为1G，Cache为8MB，页大小为512K。直接映射中，先分区在分页，一区的大小就是Cache的大小，因此一共氛围1G/1M=128， 区号为7位，每个区8M/512K=16，页号为4。

直接映射中，每个内存也只能复制到某一固定的Cache页中。即如果当前时候Cache中0页被占据，而1-15空闲，这时候将1区的0页数据调入Cache是会发生冲突的。因此直接映射的块冲突率很高。

###### 全相联映射

使用相联存储器组成的Cache存储器。在全相联映射中，主存的每一页可以映射到Cache的任一页。

对于直接映射来说，这里使用的页号直接是11位了，没有区号的概念。因此每页的Cache标记也需要11位，以表明它现在所映射的主页号，因此Cache的标记位数增加增加，比较逻辑成本增加。

主存地址不能直接提取Cache页号，需要逐个比对，直到找到标记的页，这种速度很慢，失掉了高速缓存的作用。如果主存页标记与各Cache标记同时比较，成本又太高。全相联映射方式因比较器电路难于设计和实现，只适用于小容量的Cache。

###### 组相联映射

主存中的组与Cache的组形成直接印象关系，组队的页是全相联映射关系，即主存1区0组0页，只能进入Cache的0组中，但是具体是0页还是1页没有强制要求，可以随意放置。即组是一一对应的， 页是需要查询对应的。如果每组只有一页的话，其实等同于直接映射了。如果每组页为16，那就是全相联映射。

为了保障性能，内存和Cache之间的映射一般有硬件完成，因此Cache对程序员是透明的。

##### 替换算法

- 随机
- 先入先出（FIFO）
- 最近最少使用（LRU）

##### 写操作

- 写直达：写Cache时，数据同时写回内存，当一块需要替换时，也不必把这块写回到主存中。可以直接覆盖。实现简单，随时保持主存数据的正确性，但是可能增加不必要的主存写入，降低存取速度
- 写回：CPU修改Cache后数据不like写入内存。当被淘汰的时候才写回到内存中。这种策略的cache块表中，一般由一个标识位，单元被修改时至1，需要替换时如果标识位为1那就需要先写回，如果0，表示这一块不必写入主存，直接覆盖。
- 标记法：对Cache的每个数据设置一个有效位。当数据进入Cache后，有效位置1，当CPU对数据修改时，数据只需写入内存并且置0。当要从Cache读取数据时需要测试其有效位。如果1从Cache获取，否则从内存。

### 1.3 流水线

#### 1.3.1 流水线周期

流水线应用过程中，会将需要处理的工作分为N各阶段，最耗时那一段消耗的时间为流水线周期。如：使用流水线技术执行100条指令，每条指令取指2ms，分析4ms，执行1ms，则周期为4ms

#### 1.3.2 计算流水线执行时间

将1个任务的执行过程分成N个阶段，每个阶段完成时间为t， 则完成该任务的时间为Nt，传统的角度来说，完成k个任务所需要的时间为kNt；使用流水线技术执行，花费的时间是Nt+(k-1)t。除了第一个任务需要完成的时间，其他都可以通过并行执行。

因此 ： 流水线执行时间=第一条指令的执行时间+（n-1）*流水线周期

以1.3.1的例子来说，可明显认为流水线周期为4ms，那么完成100条指令为 2+4+1+（100-1）*4=403ms

特殊：实际上，考虑处理的复杂性，会将每个执行阶段的时间统一为流水线周期，即一条指令为12ms，最后执行结果为4+4+4+4*（100-1）=408ms。

#### 1.3.3 流水线的吞吐率

任务数/处理完成对应任务数所需要用的时间

#### 1.3.4 流水线的加速比

完成同样一批任务，不使用流水线所用的时间与使用流水线所用的时间之比成为流水线的加速比。顺序执行所用时间为t0，使用流水线为t1，则加速比为t0/t1

## 2 操作系统

### 2.1 操作系统的类型与结构

#### 2.1.1 操作系统的定义

计算机系统中的核心系统软件，负责管理和控制计算机系统中的硬件和软件资源，合理的组织计算机工作流程和有效利用资源。在计算机与用户之间起接口的作用。操作系统为用户提供命令菜单窗口等，为应用程序提供API。

#### 2.1.2 操作系统分类

- 批处理操作系统
- 分时操作系统
- 实时操作系统
- 网络操作系统
- 分布式操作系统
- 嵌入式操作系统
- 微内核操作系统

### 2.2 操作系统基本原理

#### 2.2.1 进程管理



