# Java对象的内存布局

Java中，我们可以通过new，反射，Object.clone，反序列化以及Unsafe.allocateInstance方法来新建对象。

- Object.clone，反序列化方法：通过直接复制已有的数据，来初始化新建对象的实例字段。
- Unsafe.allocateInstance方法：没有初始化实例字段
- new，反射：通过调用构造器来初始化实例字段。

如果父类存在无参数构造器的话，该调用可以是**隐式**的，也就是说 Java 编译器会自动添加对父类构造器的调用。但是，如果父类没有无参数构造器，那么子类的构造器则需要显式地调用父类带参数的构造器。

显式调用又可分为两种，一是直接使用“super”关键字调用父类构造器，二是使用“this”关键字调用同一个类中的其他构造器。无论是直接的显式调用，还是间接的显式调用，都需要作为构造器的第一条语句，以便优先初始化继承而来的父类字段。（不过这可以通过调用其他生成参数的方法，或者字节码注入来绕开。）

也就是说，虽然子类无法访问父类的私有实例字段，或者子类的实例字段隐藏了父类的同名实例字段，但是**子类的实例还是会为这些父类实例字段分配内存的**。

## 1. 压缩指针

每个Java对象都有一个对象头，这个由标记字段和类型指针构成。其中，标记字段用以存储Java虚拟机有关该对象的运行数据，如哈希码，GC信息以及锁信息，类型指针指向该对象的类。

64位的Java虚拟机中，对象头的标记字段占64位，而类型指针又占了64位。即每个Java对象在内存中的额外开销就是16个字节。以Integer类为例，仅有一个int类型的私有字段，占4个字节。因此每个Integer对象的额外内存至少是int的5倍。

为了减少对象的内存使用量，64位的Java虚拟机引入了压缩指针的概念**（-XX:+UseCompressedOops,默认开启）**，将原来的64位的Java对象指针（应该是指的类型指针）压缩为32位的。

这样的话对象头的大小从16字节降至12字节。

### 1.1 实现原理

**内存对齐**：**（-XX:ObjectAlignmentInBytes，默认是8）**一个对象指针不是占据一个位置，一般会占据多个位置，因此可以默认使对应的对象指针占据若干的字节，例如每个对象指针是2个字节，那么从我要获取第2个的话，就是查询3-4位置的数据，此时记录的4， 可以用2*2来替代，即 本地只用记录一个2即可。

默认情况下，Java虚拟机堆中对象的起始地址至少要对齐8的倍数，但是如果一个对象用不到8N个字节，那么空白的那部分的空间就浪费了。这些空间称之为对象间的填充。

> 8的原因是为了让字段只出现在同一 CPU 的缓存行中, 和cpu 的缓存行大小有关, 目前主流的CPU Cache的Cache Line大小都是64Bytes,可以参考https://www.cnblogs.com/jokerjason/p/9584402.html

默认情况下，Java虚拟机的32位压缩指针，可以寻址2的35（32+3）次方个字节，即32G的地址空间，超过32G会关闭压缩指针。

就算关闭了压缩指针，Java虚拟机还是会进行内存对齐，内存对齐不仅存在于对象和对象之间，也存在于对象中的字段之间。比如Java虚拟机要求long字段，double字段以及非压缩指针状态下的引用字段地址为8的倍数。

## 2. 字段重排列

Java虚拟机重新分配字段的先后顺序，以达到内存对齐的目的。

Java虚拟机中有三种排列方法（-XX:FieldsAllocationStyle,默认为1）,遵循如下两个规则

- 如果一个字段占据C个字节，那么该字段的偏移量需要对齐至NC，这里偏移量指的是字段地址和对象的起始地址差值。
  - Long为例，在使用了压缩指针的64位虚拟机中，对象头的大小为12个字节，该long类型字段的偏移量也只能是16（8的倍数，因为long占据8个字节），中间空着的4个字节便会被浪费掉。
- 子类所继承的字段的偏移量， 需要与父类对应字段的偏移量保持一致。
  - 当启用压缩指针时，父类的字段排序可能会填充至偏移导致的缺口。
  - 关闭压缩指针后，正常分派。

> Java8引入了新的注释@contended，用来解决对象字段之间的虚共享。也会影响到字段的排列。
>
> 关于虚共享：假设两个线程分别访问同一对象中不同的volatile字段，逻辑上他们并没有贡献内容，因此不需要同步。
>
> 然而两个字段恰好在CPU同一个缓存行中，那么对这些字段的写操作会导致缓存行的写回，也就造成了实质上的共享。Java会让不同的Contended字段处于独立的缓存行中，可能存在大量空间被浪费。**（-XX:-RestrictContended）**,java9会不同



