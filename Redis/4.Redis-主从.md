# 4.Redis的主从

Redis提供了主从库模式，以保证数据副本的一致，主从库之间采用的是读写分离的方式。

- 读操作：主库，从库都可以接受
- 写操作：主库执行，主库同步操作给从库

![img](4.Redis-主从.assets/809d6707404731f7e493b832aa573a2f.jpg)

## 4.1 主从的第一次同步

启动多个Redis实例时，相关之间可以通过replicaof（Redis 5.0之前用slaveof）形成主从关系，然后按照三个阶段完成数据的第一次同步。

![img](4.Redis-主从.assets/63d18fd41efc9635e7e9105ce1c33da1.jpg)

1. 主从建立连接、协商同步的过程，为全量复制做准备。从库和主库建立起连接，并告诉主库即将进行同步，主库确认回复后，主从库间就可以开始同步了
   1. 从库给主库发送psync命令，标识进行数据同步，主库根据这个命令启动复制，psync包含主库的runID和复制进度offset两个参数
      - runID，是每个Redis实例启动时会自动生成的一个随机ID，用来唯一标记这个实例，当从库和主库第一次复制时，因为不知道主库的runID，所以这个是？
      - offset，此时设置为-1，标识第一次复制
   2. 主库收到psync命令，会用FULLRESYNC响应命令，带上主库runID和主库目前的复制进度offset，返回给从库。从库收到响应后，会记录下这两个参数。（FULLRESYNC响应表示第一次复制采用的全量复制，该主库会把当前所有的数据都复制给从库）
2. 主库将所有数据同步给从库。从库收到数据后，在本地完成数据加载。这个过程依赖于内存快照生成的RDB文件。
   - 主库执行bgsave命令，生成rdb文件，将文件发给从库，从库接收到rdb文件，先清空当前数据库，然后加载rdb文件。
   - 主库同步从库的过程中，主库不会被阻塞，仍然可以正常接收请求。但是这些请求中的写操作并没有记录到刚刚生成的RDB文件中。为了保证主从库的数据一致性，主库会在内存中用专门的replication buffer记录RDB文件生成后收到的所有写操作。
3. 主库会把第二阶段执行过程中新收到的写命令，在发送给从库。
   1. 主库完成RDB文件发送后，就会把此时replication buffer中的修改发给从库，从库执行，这样主从同步了。

## 4.2 主从级联模式

